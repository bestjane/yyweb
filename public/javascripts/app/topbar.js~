var connLockButtonSet = {};
var currTipsPanel = null;
var isPanelRefreshing = false;

function lockButton(btnName) {
  if(connLockButtonSet[btnName]) {
    return false;
  }else{
    connLockButtonSet[btnName] = btnName;
    $(btnName).css("cursor", "wait");
    return true;
  }
}

function unlockButton(btnName) {
  delete connLockButtonSet[btnName];
  $(btnName).css("cursor", "default");
}

function showTipsPanel(panelId, clearAfterHide) {
  if(currTipsPanel == panelId) {
    return;
  }
  if(currTipsPanel != null ) {
    hideTipsPanel(currTipsPanel, clearAfterHide);
  }
  currTipsPanel = panelId;
  
  var panel = $(panelId);
  panel.css("display", "inline");
  
  var filterFun = function(evt){
    evt.stopPropagation();
  };
  var hideFun = function(){
    panel.unbind("click", filterFun);
    $("html").unbind("click", hideFun);
    hideTipsPanel(panelId, clearAfterHide);
  };
  panel.click(filterFun);
  $("html").click(hideFun);
  $(".inside-button").click(clickInsideButton);
}

function hideTipsPanel(panelId, clearAfterHide) {
  var panel = $(panelId);
  panel.css("display", "none");
  if(clearAfterHide) {
    panel.html("");
  }
  currTipsPanel = null;
  $("html").unbind("click");
  $(".inside-button").unbind("click");
}

function clickInsideButton() {
  if(isPanelRefreshing) {
    return false;
  }
  isPanelRefreshing = true;
  var url = $(this).attr("href");
  setTipsPanelWaiting($(currTipsPanel));
  if(url) {
    clickInsidHref(url);
  } else {
    var form = $(this).parent();
    submitInsideForm(form, form.attr("action"));
  }
  return false;
}

function clickInsidHref(url) {
  
  $.ajax({
      type : "GET",
      url : url,
      dataType : "html",
      cache : false,
      success : onPanelCommited
  });
}

function submitInsideForm(form, url) {
  //use methods from public.js to make sure input text is empty if user wants keep it empty.
  clearTextValue();
  var data = form.serialize();
  recoverTextValue();
  
  $.ajax({
      type : "POST",
      url : url,
      dataType : "html",
      data : data,
      cache : false,
      success : onPanelCommited
  });
}

function setTipsPanelWaiting(panel) {
  //TODO next time, I will add a waiting-icon on the panel.
  panel.html("");
}

function onPanelCommited(rs) {
  if(rs=="refresh") {
    window.location.reload();
    return;
  }
  // currTipsPanel == null means the panel was close.
  if(currTipsPanel) {
    $(currTipsPanel).html(rs);
    isPanelRefreshing = false;
    $(".inside-button").click(clickInsideButton);
    initTextNotifyEvent(); // call public.js function.
  }
}

function linkButtonToPanel(buttonId, panelId, initUrl) {
  $(buttonId).click(function(){
    if(currTipsPanel == panelId) {
      return false;
    }
    if(initUrl) {
      lockButton(buttonId);
      $.ajax({
        type : "GET",
        url : initUrl,
        dateType : "html",
        cache : false,
        success : function(rs){
          unlockButton(buttonId);
          $(panelId).html(rs);
          showTipsPanel(panelId, true);
          initTextNotifyEvent(); // call public.js function.
        }
      });
    } else {
      showTipsPanel(panelId);
      initTextNotifyEvent(); // call public.js function.
    }
    return false;
  });
}

$(function(){
  linkButtonToPanel("#sign", "#top-login", "/user/loginpage");
  linkButtonToPanel("#user", "#top-user-list");
});
